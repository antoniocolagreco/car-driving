---
import type { HTMLAttributes } from 'astro/types'
import Button from '../components/button.astro'
import Input from '../components/input.astro'
import Range from '../components/range.astro'
import DefaultLayout from '../layouts/default-layout.astro'
import InfoPanel from '../components/info-panel.astro'
import InfoText from '../components/info-text.astro'

type Props = HTMLAttributes<'div'>
const { class: className, ...rest } = Astro.props
---

<script>
    import { createSimulation } from '../libs/self-driving-car'
    let simulation: { destroy: () => void } | null = null
    const boot = () => {
        const appContainer = document.querySelector('#app-container') as HTMLElement | null
        if (!appContainer) return
        simulation?.destroy?.()
        simulation = createSimulation(appContainer)
    }
    document.addEventListener('astro:page-load', boot)
    document.addEventListener('astro:before-swap', () => simulation?.destroy?.())
    window.addEventListener('pagehide', () => simulation?.destroy?.())
</script>

<DefaultLayout title="Self Driving Car">
    <div class="h-full flex flex-col grow">
        <nav class="flex gap-4 mb-2 w-full flex-wrap justify-between">
            <div class="flex gap-4 flex-wrap">
                <Button id="save-network" class="grow basis-0 min-w-0">Backup</Button>
                <Button id="restore-network" class="grow basis-0 min-w-0">Restore</Button>
                <Button id="reset-network" class="grow basis-0 min-w-0">Reset</Button>
                <Button id="restart-network" class="grow basis-0 min-w-0">Next Round</Button>
                <Button id="evolve-network" class="grow basis-0 min-w-0">Evolve</Button>
            </div>
            <div class="grid">
                <label for="mutation-rate"
                    >Mutation Rate: <span id="mutation-rate-value"></span></label
                >
                <Range
                    id="mutation-rate"
                    type="range"
                    min="1"
                    max="100"
                    value="20"
                    step="1"
                    class="w-36"
                />
            </div>
            <div class="grid">
                <label for="number-of-cars"
                    >Number of Cars: <span id="number-of-cars-value"></span></label
                >
                <Range
                    id="number-of-cars"
                    type="range"
                    min="10"
                    max="100"
                    value="50"
                    step="10"
                    class="w-36"
                />
            </div>
            <div class="grid">
                <label for="number-of-cars">Neurons</label>
                <Input id="neurons" class="w-36" />
            </div>
        </nav>
        <div id="app-container" class="h-full relative" aria-live="polite" {...rest}>
            <InfoPanel class="absolute top-0" }>
                <InfoText
                    id="info-id"
                    label="Current Car"
                    title="Identifier of the current active car"
                />
                <InfoText
                    id="info-pts"
                    label="Points"
                    title="Points accumulated by the current active car"
                />
                <InfoText
                    id="info-srv"
                    label="Survived Rounds"
                    title="Number of rounds this network has survived"
                />
                <InfoText
                    id="info-crs"
                    label="Remaining Cars"
                    title="Number of cars still competing in current generation"
                />
                <InfoText
                    id="info-timeout"
                    label="Timeout"
                    title="Remaining time before game over"
                />
                <InfoText
                    id="info-pps"
                    label="Pixels per sec."
                    title="Speed of the active car in pixels per second"
                />
                <InfoText
                    id="info-fps"
                    label="Frame per sec."
                    title="Current frames per second of the simulation"
                />
            </InfoPanel>
        </div>
    </div>
</DefaultLayout>
